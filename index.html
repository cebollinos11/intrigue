<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medieval Intrigue - Multiplayer Court Politics</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Georgia', serif;
            background: linear-gradient(135deg, #2c1810 0%, #1a0e08 100%);
            color: #d4af37;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .game-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .game-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .game-title {
            font-size: 2.5em;
            font-weight: bold;
            color: #d4af37;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }
        
        .game-subtitle {
            font-size: 1.2em;
            color: #b8860b;
            font-style: italic;
        }
        
        .lobby-screen, .game-board {
            display: none;
        }
        
        .lobby-screen.active, .game-board.active {
            display: block;
        }
        
        .lobby-container {
            max-width: 600px;
            margin: 0 auto;
            background: rgba(0,0,0,0.7);
            padding: 30px;
            border-radius: 15px;
            border: 2px solid #d4af37;
        }
        
        .lobby-title {
            font-size: 1.8em;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .player-name-input {
            width: 100%;
            padding: 15px;
            font-size: 1.1em;
            border: 2px solid #d4af37;
            border-radius: 8px;
            background: rgba(212, 175, 55, 0.1);
            color: #d4af37;
            margin-bottom: 15px;
        }
        
        .lobby-buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .lobby-btn {
            flex: 1;
            padding: 15px;
            font-size: 1.1em;
            border: 2px solid #d4af37;
            border-radius: 8px;
            background: rgba(212, 175, 55, 0.2);
            color: #d4af37;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .lobby-btn:hover {
            background: rgba(212, 175, 55, 0.4);
        }
        
        .lobby-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .room-code {
            text-align: center;
            font-size: 1.3em;
            background: rgba(212, 175, 55, 0.1);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .players-in-lobby {
            background: rgba(0,0,0,0.5);
            padding: 20px;
            border-radius: 8px;
        }
        
        .waiting-players {
            display: grid;
            gap: 10px;
        }
        
        .waiting-player {
            background: rgba(212, 175, 55, 0.1);
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #d4af37;
        }
        
        .waiting-player.ready {
            background: rgba(0, 255, 0, 0.2);
            border-color: #00ff00;
        }
        
        .start-game-btn {
            width: 100%;
            padding: 15px;
            font-size: 1.2em;
            font-weight: bold;
            margin-top: 20px;
        }
        
        .game-board {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
            min-height: 80vh;
        }
        
        .main-area {
            background: rgba(0,0,0,0.6);
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #d4af37;
        }
        
        .turn-info {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .turn-number {
            font-size: 1.5em;
            font-weight: bold;
            color: #d4af37;
        }
        
        .players-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }
        
        .player-card {
            background: rgba(139, 69, 19, 0.3);
            border: 2px solid #8b4513;
            border-radius: 10px;
            padding: 15px;
            transition: all 0.3s ease;
        }
        
        .player-card.human {
            border-color: #d4af37;
            background: rgba(212, 175, 55, 0.2);
        }
        
        .player-card.winner {
            border-color: #ffd700;
            background: rgba(255, 215, 0, 0.3);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }
        
        .player-name {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .player-type {
            font-size: 0.8em;
            padding: 3px 8px;
            background: rgba(0,0,0,0.5);
            border-radius: 12px;
        }
        
        .prestige-score {
            font-size: 1.1em;
            color: #ffd700;
            margin-bottom: 5px;
        }
        
        .player-action {
            font-size: 0.9em;
            color: #ddd;
            font-style: italic;
        }
        
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .actions-panel {
            background: rgba(0,0,0,0.6);
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #d4af37;
        }
        
        .actions-title {
            font-size: 1.3em;
            text-align: center;
            margin-bottom: 15px;
            font-weight: bold;
        }
        
        .actions-grid {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .action-button {
            background: rgba(139, 69, 19, 0.4);
            border: 2px solid #8b4513;
            border-radius: 8px;
            padding: 12px;
            color: #d4af37;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .action-button:hover {
            background: rgba(139, 69, 19, 0.6);
            border-color: #cd853f;
        }
        
        .action-button.selected {
            border-color: #d4af37;
            background: rgba(212, 175, 55, 0.3);
            box-shadow: 0 0 10px rgba(212, 175, 55, 0.5);
        }
        
        .action-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .action-description {
            font-size: 0.9em;
            opacity: 0.8;
        }
        
        .execute-turn {
            width: 100%;
            padding: 15px;
            font-size: 1.1em;
            font-weight: bold;
            background: #8b4513;
            border: 2px solid #cd853f;
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .execute-turn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .execute-turn:not(:disabled):hover {
            background: #a0522d;
            border-color: #daa520;
        }
        
        .game-log {
            background: rgba(0,0,0,0.6);
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #d4af37;
            flex: 1;
        }
        
        .log-title {
            font-size: 1.3em;
            text-align: center;
            margin-bottom: 15px;
            font-weight: bold;
        }
        
        #gameLog {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .log-entry {
            padding: 8px;
            margin-bottom: 8px;
            border-radius: 5px;
            font-size: 0.9em;
            line-height: 1.4;
        }
        
        .log-entry.turn {
            background: rgba(212, 175, 55, 0.2);
            border: 1px solid #d4af37;
            font-weight: bold;
        }
        
        .log-entry.action {
            background: rgba(139, 69, 19, 0.2);
            border: 1px solid #8b4513;
        }
        
        .game-over {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .game-over-content {
            background: rgba(139, 69, 19, 0.9);
            border: 3px solid #d4af37;
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            max-width: 500px;
        }
        
        .game-over-title {
            font-size: 2.5em;
            margin-bottom: 20px;
            color: #ffd700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }
        
        .winner-announcement {
            font-size: 1.2em;
            margin-bottom: 30px;
            line-height: 1.5;
        }
        
        .restart-button {
            padding: 15px 30px;
            font-size: 1.2em;
            font-weight: bold;
            background: #8b4513;
            border: 2px solid #d4af37;
            border-radius: 10px;
            color: #fff;
            cursor: pointer;
        }
        
        .waiting-indicator {
            text-align: center;
            padding: 20px;
            font-style: italic;
            color: #b8860b;
        }
        
        @media (max-width: 1000px) {
            .game-board {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                order: -1;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="game-header">
            <div class="game-title">⚔️ Medieval Intrigue ⚔️</div>
            <div class="game-subtitle">Multiplayer Court Politics & Noble Schemes</div>
        </div>
        
        <!-- Lobby Screen -->
        <div class="lobby-screen active" id="lobbyScreen">
            <div class="lobby-container">
                <div class="lobby-title">🏰 Enter the Court</div>
                
                <input type="text" id="playerNameInput" class="player-name-input" placeholder="Enter your noble family name..." maxlength="20">
                
                <div class="lobby-buttons">
                    <button class="lobby-btn" id="createRoomBtn">Create Room</button>
                    <button class="lobby-btn" id="joinRoomBtn">Join Room</button>
                </div>
                
                <input type="text" id="roomCodeInput" class="player-name-input" placeholder="Enter room code..." maxlength="10" style="display: none;">
                
                <div id="roomInfo" style="display: none;">
                    <div class="room-code">
                        Room Code: <span id="roomCodeDisplay"></span>
                        <br><small>Share this code with other players</small>
                    </div>
                    
                    <div class="players-in-lobby">
                        <div style="margin-bottom: 15px; font-weight: bold;">Players in Room:</div>
                        <div id="waitingPlayers" class="waiting-players"></div>
                        <button class="lobby-btn start-game-btn" id="startGameBtn" style="display: none;">Start Game</button>
                        <button class="lobby-btn" id="readyBtn" style="display: none;">Ready</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Game Board -->
        <div class="game-board" id="gameBoard">
            <div class="main-area">
                <div class="turn-info">
                    <div class="turn-number">Turn <span id="turnNumber">1</span></div>
                    <div id="turnStatus">Choose your action wisely, noble lord...</div>
                </div>
                
                <div class="players-grid" id="playersGrid">
                    <!-- Players will be populated by JavaScript -->
                </div>
            </div>
            
            <div class="sidebar">
                <div class="actions-panel">
                    <div class="actions-title">🏰 Choose Your Action</div>
                    <div class="actions-grid" id="actionsGrid">
                        <!-- Actions will be populated by JavaScript -->
                    </div>
                    <button class="execute-turn" id="executeTurn" disabled>Submit Action</button>
                </div>
                
                <div class="game-log">
                    <div class="log-title">📜 Court Chronicles</div>
                    <div id="gameLog">
                        <div class="log-entry">The old king sits upon his throne, easily swayed by whispers and gold. The noble families gather, each plotting their rise to power...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="game-over" id="gameOver">
        <div class="game-over-content">
            <div class="game-over-title">🏆 Victory Achieved! 🏆</div>
            <div class="winner-announcement" id="winnerText"></div>
            <button class="restart-button" onclick="returnToLobby()">Return to Lobby</button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <script>
        // Firebase configuration - REPLACE WITH YOUR CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyASsaGcx_0wzbXSTKobgEsBpNnNgG0_v6A",
            authDomain: "medievalintrigueclaude.firebaseapp.com",
            projectId: "medievalintrigueclaude",
            databaseURL: "https://medievalintrigueclaude-default-rtdb.europe-west1.firebasedatabase.app/",  // Make sure this matches exactly from Firebase Console

            storageBucket: "medievalintrigueclaude.firebasestorage.app",
            messagingSenderId: "712288326971",
            appId: "1:712288326971:web:8813d07c7b0892b3a4d31e",
            measurementId: "G-F5LSNG913W"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Game configuration
        const GAME_CONFIG = {
            ACTIONS: {
                protect: { name: "🛡️ Protect", description: "Gain 2 prestige and immunity", points: 2, priority: 1 },
                rumor: { name: "👥 Spread Rumors", description: "Damage rival, gain prestige", damage: 3, points: 2, priority: 2 },
                favor: { name: "💰 Court Favor", description: "Exclusive: +4, Contested: -2", points: 4, penalty: 2, priority: 3 },
                campaign: { name: "🤝 Campaign", description: "Collaborate for bonus prestige", points: 3, priority: 4 },
                invest: { name: "📈 Invest", description: "Steady +3 prestige gain", points: 3, priority: 5 },
                bank: { name: "🏦 Banking", description: "Profit from others' investments", points: 2, priority: 6 }
            },
            GAME_SETTINGS: {
                MIN_PLAYERS: 2,
                MAX_PLAYERS: 6,
                STARTING_PRESTIGE: 10,
                WIN_CONDITION: 25,
                MAX_TURNS: 15,
                MAX_LOG_ENTRIES: 50
            }
        };

        class MultiplayerMedievalGame {
            constructor() {
                this.playerId = null;
                this.playerName = '';
                this.roomCode = '';
                this.gameRef = null;
                this.isHost = false;
                this.selectedAction = null;
                this.gameState = null;
                
                this.initializeUI();
            }

            initializeUI() {
                document.getElementById('createRoomBtn').onclick = () => this.createRoom();
                document.getElementById('joinRoomBtn').onclick = () => this.showJoinRoom();
                document.getElementById('startGameBtn').onclick = () => this.startGame();
                document.getElementById('readyBtn').onclick = () => this.toggleReady();
                document.getElementById('executeTurn').onclick = () => this.submitAction();

                // Handle room code input
                document.getElementById('roomCodeInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.joinRoom();
                    }
                });

                document.getElementById('playerNameInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.createRoom();
                    }
                });
            }

            async createRoom() {
                const nameInput = document.getElementById('playerNameInput');
                const name = nameInput.value.trim();
                
                if (!name) {
                    alert('Please enter your family name');
                    return;
                }

                this.playerName = name;
                this.playerId = this.generatePlayerId();
                this.roomCode = this.generateRoomCode();
                this.isHost = true;

                // Create room in Firebase
                const roomRef = database.ref(`rooms/${this.roomCode}`);
                await roomRef.set({
                    host: this.playerId,
                    created: Date.now(),
                    gameState: 'lobby',
                    players: {
                        [this.playerId]: {
                            name: this.playerName,
                            ready: true,
                            joinedAt: Date.now()
                        }
                    }
                });

                this.gameRef = roomRef;
                this.showRoomInfo();
                this.listenToRoom();
            }

            showJoinRoom() {
                const roomCodeInput = document.getElementById('roomCodeInput');
                roomCodeInput.style.display = 'block';
                roomCodeInput.focus();

                // Add join button functionality
                const joinBtn = document.getElementById('joinRoomBtn');
                joinBtn.textContent = 'Connect';
                joinBtn.onclick = () => this.joinRoom();
            }

            async joinRoom() {
                const nameInput = document.getElementById('playerNameInput');
                const roomCodeInput = document.getElementById('roomCodeInput');
                const name = nameInput.value.trim();
                const code = roomCodeInput.value.trim().toUpperCase();

                if (!name || !code) {
                    alert('Please enter both your name and room code');
                    return;
                }

                this.playerName = name;
                this.playerId = this.generatePlayerId();
                this.roomCode = code;

                // Check if room exists
                const roomRef = database.ref(`rooms/${this.roomCode}`);
                const snapshot = await roomRef.once('value');
                
                if (!snapshot.exists()) {
                    alert('Room not found. Please check the code.');
                    return;
                }

                const roomData = snapshot.val();
                const playerCount = Object.keys(roomData.players || {}).length;

                if (playerCount >= GAME_CONFIG.GAME_SETTINGS.MAX_PLAYERS) {
                    alert('Room is full');
                    return;
                }

                if (roomData.gameState !== 'lobby') {
                    alert('Game has already started');
                    return;
                }

                // Add player to room
                await roomRef.child(`players/${this.playerId}`).set({
                    name: this.playerName,
                    ready: false,
                    joinedAt: Date.now()
                });

                this.gameRef = roomRef;
                this.showRoomInfo();
                this.listenToRoom();
            }

            showRoomInfo() {
                document.getElementById('roomCodeDisplay').textContent = this.roomCode;
                document.getElementById('roomInfo').style.display = 'block';
                
                if (this.isHost) {
                    document.getElementById('startGameBtn').style.display = 'block';
                } else {
                    document.getElementById('readyBtn').style.display = 'block';
                }
            }

            listenToRoom() {
                this.gameRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (!data) return;

                    this.updateLobby(data);

                    if (data.gameState === 'playing') {
                        this.gameState = data.game;
                        this.showGameBoard();
                        this.updateGameDisplay();
                    }
                });
            }

            updateLobby(roomData) {
                const waitingPlayers = document.getElementById('waitingPlayers');
                waitingPlayers.innerHTML = '';

                Object.entries(roomData.players || {}).forEach(([id, player]) => {
                    const playerDiv = document.createElement('div');
                    playerDiv.className = `waiting-player ${player.ready ? 'ready' : ''}`;
                    playerDiv.innerHTML = `
                        ${player.name} ${id === roomData.host ? '(Host)' : ''}
                        ${player.ready ? '✅ Ready' : '⏳ Not Ready'}
                    `;
                    waitingPlayers.appendChild(playerDiv);
                });

                // Update start button visibility for host
                if (this.isHost) {
                    const allReady = Object.values(roomData.players || {}).every(p => p.ready);
                    const playerCount = Object.keys(roomData.players || {}).length;
                    const startBtn = document.getElementById('startGameBtn');
                    startBtn.style.display = (allReady && playerCount >= GAME_CONFIG.GAME_SETTINGS.MIN_PLAYERS) ? 'block' : 'none';
                }
            }

            async toggleReady() {
                const readyBtn = document.getElementById('readyBtn');
                const currentReady = readyBtn.textContent === 'Not Ready';
                
                await this.gameRef.child(`players/${this.playerId}/ready`).set(!currentReady);
                readyBtn.textContent = !currentReady ? 'Not Ready' : 'Ready';
            }

            async startGame() {
                const snapshot = await this.gameRef.once('value');
                const roomData = snapshot.val();
                const players = Object.entries(roomData.players || {}).map(([id, data], index) => ({
                    id,
                    name: data.name,
                    prestige: GAME_CONFIG.GAME_SETTINGS.STARTING_PRESTIGE,
                    action: null,
                    protected: false,
                    isHuman: true,
                    submitted: false
                }));

                const gameState = {
                    turn: 1,
                    maxTurns: GAME_CONFIG.GAME_SETTINGS.MAX_TURNS,
                    winCondition: GAME_CONFIG.GAME_SETTINGS.WIN_CONDITION,
                    players,
                    gameLog: [],
                    phase: 'action_selection', // 'action_selection', 'waiting_for_players', 'resolving'
                    winner: null
                };

                await this.gameRef.update({
                    gameState: 'playing',
                    game: gameState
                });
            }

            showGameBoard() {
                document.getElementById('lobbyScreen').classList.remove('active');
                document.getElementById('gameBoard').classList.add('active');
                this.renderActions();
            }

            renderActions() {
                const grid = document.getElementById('actionsGrid');
                grid.innerHTML = '';
                
                Object.entries(GAME_CONFIG.ACTIONS).forEach(([key, action]) => {
                    const button = document.createElement('button');
                    button.className = `action-button ${this.selectedAction === key ? 'selected' : ''}`;
                    button.onclick = () => this.selectAction(key);
                    
                    button.innerHTML = `
                        <div class="action-title">${action.name}</div>
                        <div class="action-description">${action.description}</div>
                    `;
                    
                    grid.appendChild(button);
                });
            }

            selectAction(actionKey) {
                this.selectedAction = actionKey;
                this.renderActions();
                document.getElementById('executeTurn').disabled = false;
            }

            async submitAction() {
                if (!this.selectedAction || !this.gameState) return;

                // Mark player as submitted and set their action
                const playerUpdates = {};
                playerUpdates[`game/players/${this.getPlayerIndex()}/action`] = this.selectedAction;
                playerUpdates[`game/players/${this.getPlayerIndex()}/submitted`] = true;

                await this.gameRef.update(playerUpdates);

                this.selectedAction = null;
                document.getElementById('executeTurn').disabled = true;
                this.renderActions();
            }

            getPlayerIndex() {
                return this.gameState.players.findIndex(p => p.id === this.playerId);
            }

            updateGameDisplay() {
                if (!this.gameState) return;

                // Update turn number
                document.getElementById('turnNumber').textContent = this.gameState.turn;

                // Update turn status
                const allSubmitted = this.gameState.players.every(p => p.submitted);
                const myPlayer = this.gameState.players.find(p => p.id === this.playerId);
                
                let statusText = '';
                if (myPlayer && myPlayer.submitted) {
                    statusText = allSubmitted ? 'All actions submitted! Resolving...' : 'Waiting for other players...';
                } else {
                    statusText = 'Choose your action wisely, noble lord...';
                }
                document.getElementById('turnStatus').textContent = statusText;

                // Check if all players have submitted and resolve turn (only host does this)
                if (this.isHost && allSubmitted && this.gameState.phase === 'action_selection') {
                    this.resolveTurn();
                }

                this.renderPlayers();
                this.renderLog();

                // Check for game over
                if (this.gameState.winner || this.gameState.turn > this.gameState.maxTurns) {
                    this.showGameOver();
                }
            }

            async resolveTurn() {
                // Set phase to resolving to prevent multiple resolutions
                await this.gameRef.child('game/phase').set('resolving');

                const newGameState = { ...this.gameState };

                    // Ensure gameLog exists and is an array
                if (!newGameState.gameLog || !Array.isArray(newGameState.gameLog)) {
                    newGameState.gameLog = [];
                }
                
                // Clear protection status from previous turn
                newGameState.players.forEach(player => player.protected = false);
                
                // Group actions by type
                const actionGroups = {};
                newGameState.players.forEach(player => {
                    if (!actionGroups[player.action]) {
                        actionGroups[player.action] = [];
                    }
                    actionGroups[player.action].push(player);
                });
                
                // Execute actions in priority order
                const actionOrder = Object.keys(GAME_CONFIG.ACTIONS).sort((a, b) => 
                    GAME_CONFIG.ACTIONS[a].priority - GAME_CONFIG.ACTIONS[b].priority
                );
                

                newGameState.gameLog.push({
                    message: `Turn ${newGameState.turn} Results:`,
                    type: 'turn',
                    timestamp: Date.now()
                });
                
                actionOrder.forEach(actionKey => {
                    if (actionGroups[actionKey]) {
                        this.executeAction(actionKey, actionGroups[actionKey], actionGroups, newGameState);
                    }
                });
                
                // Check win condition
                const winner = newGameState.players.find(player => player.prestige >= newGameState.winCondition);
                if (winner || newGameState.turn >= newGameState.maxTurns) {
                    newGameState.winner = winner;
                } else {
                    newGameState.turn++;
                    newGameState.players.forEach(player => {
                        player.action = null;
                        player.submitted = false;
                    });
                    newGameState.phase = 'action_selection';
                }
                
                await this.gameRef.child('game').set(newGameState);
            }

            executeAction(actionKey, players, allGroups, gameState) {
                const action = GAME_CONFIG.ACTIONS[actionKey];
                
                switch (actionKey) {
                    case 'protect':
                        players.forEach(player => {
                            player.prestige += action.points;
                            player.protected = true;
                            gameState.gameLog.push({
                                message: `${player.name} fortifies their position, gaining ${action.points} prestige and protection`,
                                type: 'action',
                                timestamp: Date.now()
                            });
                        });
                        break;
                        
                    case 'rumor':
                        players.forEach(player => {
                            const maxPrestige = Math.max(...gameState.players.map(p => p.prestige));
                            const topPlayers = gameState.players.filter(p => !p.protected && p.prestige === maxPrestige);
                            const possibleTargets = topPlayers.filter(p => p.id !== player.id);

                            if (possibleTargets.length > 0) {
                                const target = possibleTargets[Math.floor(Math.random() * possibleTargets.length)];
                                target.prestige -= action.damage;
                                player.prestige += action.points;
                                gameState.gameLog.push({
                                    message: `${player.name} spreads damaging rumors about ${target.name}, dealing ${action.damage} damage and gaining ${action.points} prestige`,
                                    type: 'action',
                                    timestamp: Date.now()
                                });
                            } else {
                                gameState.gameLog.push({
                                    message: `${player.name}'s rumors find no suitable target`,
                                    type: 'action',
                                    timestamp: Date.now()
                                });
                            }
                        });
                        break;
                        
                    case 'favor':
                        if (players.length === 1) {
                            players[0].prestige += action.points;
                            gameState.gameLog.push({
                                message: `${players[0].name} gains exclusive court favor, earning ${action.points} prestige`,
                                type: 'action',
                                timestamp: Date.now()
                            });
                        } else {
                            players.forEach(player => {
                                player.prestige -= action.penalty;
                                gameState.gameLog.push({
                                    message: `${player.name} competes for court favor but loses ${action.penalty} prestige in the struggle`,
                                    type: 'action',
                                    timestamp: Date.now()
                                });
                            });
                        }
                        break;
                        
                    case 'campaign':
                        if (players.length === 1) {
                            gameState.gameLog.push({
                                message: `${players[0].name} campaigns alone but gains no benefit`,
                                type: 'action',
                                timestamp: Date.now()
                            });
                        } else {
                            const bonus = action.points * players.length;
                            players.forEach(player => {
                                player.prestige += bonus;
                                gameState.gameLog.push({
                                    message: `${player.name} joins a ${players.length}-person campaign, earning ${bonus} prestige`,
                                    type: 'action',
                                    timestamp: Date.now()
                                });
                            });
                        }
                        break;
                        
                    case 'invest':
                        players.forEach(player => {
                            player.prestige += action.points;
                            gameState.gameLog.push({
                                message: `${player.name} makes wise investments, gaining ${action.points} prestige`,
                                type: 'action',
                                timestamp: Date.now()
                            });
                        });
                        break;
                        
                    case 'bank':
                        const investorCount = allGroups['invest'] ? allGroups['invest'].length : 0;
                        players.forEach(player => {
                            const bonus = action.points * investorCount;
                            player.prestige += bonus;
                            gameState.gameLog.push({
                                message: `${player.name} profits from banking, earning ${bonus} prestige from ${investorCount} investors`,
                                type: 'action',
                                timestamp: Date.now()
                            });
                        });
                        break;
                }
                
                // Ensure prestige doesn't go below 0
                gameState.players.forEach(player => {
                    if (player.prestige < 0) player.prestige = 0;
                });
            }

            renderPlayers() {
                const grid = document.getElementById('playersGrid');
                grid.innerHTML = '';
                
                // Sort players by prestige (descending)
                const sortedPlayers = [...this.gameState.players].sort((a, b) => b.prestige - a.prestige);
                
                sortedPlayers.forEach(player => {
                    const card = document.createElement('div');
                    const isMyPlayer = player.id === this.playerId;
                    const isWinner = player.prestige >= this.gameState.winCondition;
                    
                    card.className = `player-card ${isMyPlayer ? 'human' : ''} ${isWinner ? 'winner' : ''}`;
                    
                    let actionText = 'Awaiting action...';
                    if (player.submitted) {
                        actionText = 'Action submitted ✅';
                    } else if (player.action) {
                        actionText = `Last: ${GAME_CONFIG.ACTIONS[player.action].name}`;
                    }
                    
                    card.innerHTML = `
                        <div class="player-name">
                            ${player.name}
                            <span class="player-type">${isMyPlayer ? 'You' : 'Player'}</span>
                        </div>
                        <div class="prestige-score">👑 ${player.prestige} Prestige</div>
                        <div class="player-action">${actionText}</div>
                    `;
                    
                    grid.appendChild(card);
                });
            }

        renderLog() {
            const log = document.getElementById('gameLog');
            const entries = this.gameState.gameLog || []; // fallback if undefined

            log.innerHTML = entries.map(entry =>
                `<div class="log-entry ${entry.type}">${entry.message}</div>`
            ).join('');

            log.scrollTop = log.scrollHeight;
        }

            showGameOver() {
                const gameOverDiv = document.getElementById('gameOver');
                const winnerText = document.getElementById('winnerText');
                
                if (this.gameState.winner) {
                    const isMyWin = this.gameState.winner.id === this.playerId;
                    if (isMyWin) {
                        winnerText.innerHTML = `
                            <div style="font-size: 1.5em; margin-bottom: 15px;">Congratulations!</div>
                            <div>You have achieved victory through superior political maneuvering!</div>
                            <div style="margin-top: 15px;"><strong>${this.gameState.winner.name}</strong> wins with <strong>${this.gameState.winner.prestige} prestige</strong>!</div>
                        `;
                    } else {
                        winnerText.innerHTML = `
                            <div style="font-size: 1.5em; margin-bottom: 15px;">Game Over</div>
                            <div><strong>${this.gameState.winner.name}</strong> has outmaneuvered all rivals and risen to prominence at court!</div>
                            <div style="margin-top: 15px;">Final prestige: <strong>${this.gameState.winner.prestige}</strong></div>
                        `;
                    }
                } else {
                    const topPlayer = [...this.gameState.players].sort((a, b) => b.prestige - a.prestige)[0];
                    winnerText.innerHTML = `
                        <div style="font-size: 1.5em; margin-bottom: 15px;">Time's Up!</div>
                        <div>After ${this.gameState.maxTurns} turns of political intrigue, <strong>${topPlayer.name}</strong> holds the most influence!</div>
                        <div style="margin-top: 15px;">Final prestige: <strong>${topPlayer.prestige}</strong></div>
                    `;
                }
                
                gameOverDiv.style.display = 'flex';
            }

            generateRoomCode() {
                return Math.random().toString(36).substring(2, 8).toUpperCase();
            }

            generatePlayerId() {
                return Date.now().toString(36) + Math.random().toString(36).substring(2);
            }
        }

        function returnToLobby() {
            location.reload();
        }

        // Initialize game when page loads
        window.addEventListener('load', () => {
            new MultiplayerMedievalGame();
        });
    </script>
</body>
</html>